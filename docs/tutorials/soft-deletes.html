<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soft Deletes Tutorial - SIMPLE_SQL</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>SIMPLE_SQL</h1>
                <span class="version">v1.0 - 460+ Tests</span>
            </div>

            <div class="nav-section">
                <h3>Getting Started</h3>
                <ul>
                    <li><a href="../index.html">Overview</a></li>
                    <li><a href="../getting-started.html">Quick Start</a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3>Tutorials</h3>
                <ul>
                    <li><a href="basic-crud.html">Basic CRUD</a></li>
                    <li><a href="query-builder.html">Query Builder</a></li>
                    <li><a href="transactions.html">Transactions</a></li>
                    <li><a href="soft-deletes.html" class="active">Soft Deletes</a></li>
                    <li><a href="eager-loading.html">Eager Loading</a></li>
                    <li><a href="pagination.html">Pagination</a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3>API Reference</h3>
                <ul>
                    <li><a href="../api/select-builder.html">SIMPLE_SQL_SELECT_BUILDER</a></li>
                </ul>
            </div>
        </nav>

        <main class="main-content">
            <div class="breadcrumbs">
                <a href="../index.html">Home</a> <span>›</span> <a href="../index.html#tutorials">Tutorials</a> <span>›</span> Soft Deletes
            </div>

            <h1>Implementing Soft Deletes</h1>
            <p>Soft deletes allow you to "delete" records without actually removing them from the database. Instead, records are marked as deleted and filtered out of normal queries. This enables data recovery, audit trails, and undo functionality.</p>

            <h2>Schema Design</h2>
            <p>Add a nullable timestamp column to track when records were deleted:</p>
            <pre><code class="eiffel">db.execute (<span class="string">"CREATE TABLE documents (id INTEGER PRIMARY KEY, name TEXT NOT NULL, content TEXT, deleted_at TEXT DEFAULT NULL, created_at TEXT DEFAULT CURRENT_TIMESTAMP)"</span>)</code></pre>

            <div class="callout info">
                <div class="callout-title">Column Convention</div>
                <p>SIMPLE_SQL uses <code>deleted_at</code> as the default soft delete column. Use <code>set_soft_delete_column</code> if your schema uses a different name like <code>is_deleted</code> or <code>archived_at</code>.</p>
            </div>

            <h2>Soft Delete a Record</h2>
            <p>Instead of DELETE, UPDATE the <code>deleted_at</code> timestamp:</p>
            <pre><code class="eiffel"><span class="comment">-- Soft delete a document</span>
db.update (<span class="string">"documents"</span>)
    .set (<span class="string">"deleted_at"</span>, datetime.formatted_out (<span class="string">"yyyy-mm-dd hh:mi:ss"</span>))
    .where (<span class="string">"id = ?"</span>, doc_id)
    .execute

<span class="comment">-- Or use SQLite's built-in timestamp</span>
db.execute_with_args (<span class="string">"UPDATE documents SET deleted_at = datetime('now') WHERE id = ?"</span>, &lt;&lt;doc_id&gt;&gt;)</code></pre>

            <h2>Query Active Records Only</h2>
            <p>Use the <code>active_only</code> scope to automatically filter out deleted records:</p>
            <pre><code class="eiffel"><span class="comment">-- Only returns records where deleted_at IS NULL</span>
result := db.select_from (<span class="string">"documents"</span>)
    .columns (<span class="string">"id, name, created_at"</span>)
    .active_only
    .order_by (<span class="string">"name"</span>)
    .execute

<span class="keyword">across</span> result <span class="keyword">as</span> doc <span class="keyword">loop</span>
    print (doc.string_value (<span class="string">"name"</span>) + <span class="string">"%N"</span>)
<span class="keyword">end</span></code></pre>

            <h2>Query Deleted Records (Trash View)</h2>
            <p>Use <code>deleted_only</code> to show only soft-deleted records:</p>
            <pre><code class="eiffel"><span class="comment">-- Show items in trash</span>
result := db.select_from (<span class="string">"documents"</span>)
    .columns (<span class="string">"id, name, deleted_at"</span>)
    .deleted_only
    .order_by (<span class="string">"deleted_at DESC"</span>)  <span class="comment">-- Most recently deleted first</span>
    .execute

print (<span class="string">"Trash (%N items):%N"</span>)
<span class="keyword">across</span> result <span class="keyword">as</span> doc <span class="keyword">loop</span>
    print (<span class="string">"  - "</span> + doc.string_value (<span class="string">"name"</span>) + <span class="string">" (deleted "</span> + doc.string_value (<span class="string">"deleted_at"</span>) + <span class="string">")%N"</span>)
<span class="keyword">end</span></code></pre>

            <h2>Query All Records (Admin View)</h2>
            <p>Use <code>with_deleted</code> to include both active and deleted records:</p>
            <pre><code class="eiffel"><span class="comment">-- Admin view: show everything</span>
result := db.select_from (<span class="string">"documents"</span>)
    .columns (<span class="string">"id, name, deleted_at"</span>)
    .with_deleted
    .execute

<span class="keyword">across</span> result <span class="keyword">as</span> doc <span class="keyword">loop</span>
    <span class="keyword">if</span> <span class="keyword">attached</span> doc.string_value_or_void (<span class="string">"deleted_at"</span>) <span class="keyword">as</span> deleted <span class="keyword">then</span>
        print (doc.string_value (<span class="string">"name"</span>) + <span class="string">" [DELETED]%N"</span>)
    <span class="keyword">else</span>
        print (doc.string_value (<span class="string">"name"</span>) + <span class="string">"%N"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>

            <h2>Restore a Soft-Deleted Record</h2>
            <p>Simply set <code>deleted_at</code> back to NULL:</p>
            <pre><code class="eiffel"><span class="comment">-- Restore from trash</span>
db.update (<span class="string">"documents"</span>)
    .set_null (<span class="string">"deleted_at"</span>)
    .where (<span class="string">"id = ?"</span>, doc_id)
    .execute</code></pre>

            <h2>Permanently Delete (Hard Delete)</h2>
            <p>When you really need to remove data (GDPR, storage cleanup, etc.):</p>
            <pre><code class="eiffel"><span class="comment">-- Hard delete items in trash older than 30 days</span>
db.delete_from (<span class="string">"documents"</span>)
    .where (<span class="string">"deleted_at IS NOT NULL AND deleted_at < datetime('now', '-30 days')"</span>)
    .execute

print (<span class="string">"Purged "</span> + db.changes.out + <span class="string">" old items from trash%N"</span>)</code></pre>

            <h2>Custom Column Name</h2>
            <p>If your schema uses a different column name:</p>
            <pre><code class="eiffel"><span class="comment">-- Table uses 'archived_at' instead of 'deleted_at'</span>
result := db.select_from (<span class="string">"posts"</span>)
    .set_soft_delete_column (<span class="string">"archived_at"</span>)
    .active_only  <span class="comment">-- Now checks archived_at IS NULL</span>
    .execute</code></pre>

            <h2>Combining with Other Filters</h2>
            <p>Soft delete scopes combine with other WHERE conditions:</p>
            <pre><code class="eiffel"><span class="comment">-- Active documents in a specific folder</span>
result := db.select_from (<span class="string">"documents"</span>)
    .active_only
    .where (<span class="string">"folder_id = ?"</span>, folder_id)
    .order_by (<span class="string">"name"</span>)
    .execute

<span class="comment">-- Recently deleted documents by user</span>
result := db.select_from (<span class="string">"documents"</span>)
    .deleted_only
    .where (<span class="string">"created_by = ?"</span>, user_id)
    .where (<span class="string">"deleted_at > datetime('now', '-7 days')"</span>)
    .execute</code></pre>

            <h2>Best Practices</h2>

            <div class="callout success">
                <div class="callout-title">Do</div>
                <ul>
                    <li>Use <code>active_only</code> as your default scope for user-facing queries</li>
                    <li>Index the <code>deleted_at</code> column for better filter performance</li>
                    <li>Implement a scheduled job to hard-delete old trashed items</li>
                    <li>Show "Trash" or "Archive" views to let users restore items</li>
                </ul>
            </div>

            <div class="callout warning">
                <div class="callout-title">Don't</div>
                <ul>
                    <li>Forget to add <code>active_only</code> - you'll show deleted items to users</li>
                    <li>Use soft deletes for temporary/session data - just hard delete</li>
                    <li>Keep soft-deleted data forever - implement a retention policy</li>
                </ul>
            </div>

            <h2>Complete Example: Document Manager</h2>
            <pre><code class="eiffel"><span class="keyword">class</span> <span class="class-name">DOCUMENT_MANAGER</span>

<span class="keyword">feature</span> <span class="comment">-- Access</span>

    all_documents: <span class="class-name">SIMPLE_SQL_RESULT</span>
            <span class="comment">-- All active documents</span>
        <span class="keyword">do</span>
            Result := db.select_from (<span class="string">"documents"</span>).active_only.order_by (<span class="string">"name"</span>).execute
        <span class="keyword">end</span>

    trash: <span class="class-name">SIMPLE_SQL_RESULT</span>
            <span class="comment">-- Documents in trash</span>
        <span class="keyword">do</span>
            Result := db.select_from (<span class="string">"documents"</span>).deleted_only.order_by (<span class="string">"deleted_at DESC"</span>).execute
        <span class="keyword">end</span>

<span class="keyword">feature</span> <span class="comment">-- Operations</span>

    delete (a_id: <span class="class-name">INTEGER_64</span>)
            <span class="comment">-- Soft delete a document</span>
        <span class="keyword">do</span>
            db.execute_with_args (<span class="string">"UPDATE documents SET deleted_at = datetime('now') WHERE id = ?"</span>, &lt;&lt;a_id&gt;&gt;)
        <span class="keyword">end</span>

    restore (a_id: <span class="class-name">INTEGER_64</span>)
            <span class="comment">-- Restore from trash</span>
        <span class="keyword">do</span>
            db.update (<span class="string">"documents"</span>).set_null (<span class="string">"deleted_at"</span>).where (<span class="string">"id = ?"</span>, a_id).execute
        <span class="keyword">end</span>

    empty_trash
            <span class="comment">-- Permanently delete all trashed documents</span>
        <span class="keyword">do</span>
            db.delete_from (<span class="string">"documents"</span>).where (<span class="string">"deleted_at IS NOT NULL"</span>).execute
        <span class="keyword">end</span>

    purge_old_trash (a_days: <span class="class-name">INTEGER</span>)
            <span class="comment">-- Delete items in trash older than `a_days`</span>
        <span class="keyword">do</span>
            db.execute_with_args (<span class="string">"DELETE FROM documents WHERE deleted_at IS NOT NULL AND deleted_at < datetime('now', '-' || ? || ' days')"</span>, &lt;&lt;a_days&gt;&gt;)
        <span class="keyword">end</span>

<span class="keyword">end</span></code></pre>

            <div class="doc-footer">
                <p><a href="transactions.html">← Transactions</a> | <a href="eager-loading.html">Eager Loading →</a></p>
                <p>API Reference: <a class="eis-link" href="eiffel:?class=SIMPLE_SQL_SELECT_BUILDER&feature=active_only">active_only</a></p>
            </div>
        </main>
    </div>
</body>
</html>
