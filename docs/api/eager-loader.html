<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPLE_SQL_EAGER_LOADER - API Reference</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>SIMPLE_SQL</h1>
                <span class="version">v1.0 - 460+ Tests</span>
            </div>

            <div class="nav-section">
                <h3>Getting Started</h3>
                <ul>
                    <li><a href="../index.html">Overview</a></li>
                    <li><a href="../getting-started.html">Quick Start</a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3>Core API</h3>
                <ul>
                    <li><a href="database.html">SIMPLE_SQL_DATABASE</a></li>
                    <li><a href="result.html">SIMPLE_SQL_RESULT</a></li>
                    <li><a href="row.html">SIMPLE_SQL_ROW</a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3>Advanced Features</h3>
                <ul>
                    <li><a href="eager-loader.html" class="active">Eager Loading (N+1)</a></li>
                    <li><a href="paginator.html">Pagination</a></li>
                    <li><a href="query-monitor.html">Query Monitor</a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3>Tutorials</h3>
                <ul>
                    <li><a href="../tutorials/eager-loading.html">Eager Loading Guide</a></li>
                </ul>
            </div>
        </nav>

        <main class="main-content">
            <div class="breadcrumbs">
                <a href="../index.html">Home</a> <span>›</span> <a href="../index.html#api">API</a> <span>›</span> SIMPLE_SQL_EAGER_LOADER
            </div>

            <h1>SIMPLE_SQL_EAGER_LOADER</h1>
            <p>Eliminates N+1 query problems by batch-loading related data. Instead of one query per parent row, loads all related data in a single additional query per relationship.</p>
            <p><a class="eis-link" href="eiffel:?class=SIMPLE_SQL_EAGER_LOADER">View Source</a></p>

            <div class="callout warning">
                <div class="callout-title">The N+1 Problem</div>
                <p>Without eager loading, fetching 100 documents with their folders requires <strong>101 queries</strong>:
                1 for documents + 100 for each folder. With eager loading: <strong>2 queries</strong> total.</p>
            </div>

            <div class="api-class">
                <div class="api-class-header">
                    <h2>Setup</h2>
                </div>
                <div class="api-class-body">
                    <div class="api-feature">
                        <div class="api-feature-sig">from_table (a_table: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Set the main table to query from.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">columns (a_columns: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Columns to select from main table. Default is <code>*</code>.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">where (a_condition: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Filter main table rows.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">order_by (a_ordering: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Order main table results.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">limit (a_count: INTEGER): like Current</div>
                        <div class="api-feature-desc">Limit main table rows.</div>
                    </div>
                </div>
            </div>

            <div class="api-class">
                <div class="api-class-header">
                    <h2>Include Related Data</h2>
                </div>
                <div class="api-class-body">
                    <div class="api-feature">
                        <div class="api-feature-sig">include (a_relation, a_table, a_fk, a_pk: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Include a direct FK relationship. <code>a_fk</code> on main table points to <code>a_pk</code> on related table.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">include_many_to_many (a_relation, a_table, a_join_table, a_main_fk, a_related_fk: READABLE_STRING_8): like Current</div>
                        <div class="api-feature-desc">Include a many-to-many relationship through a join table.</div>
                    </div>
                </div>
            </div>

            <div class="api-class">
                <div class="api-class-header">
                    <h2>Execution</h2>
                </div>
                <div class="api-class-body">
                    <div class="api-feature">
                        <div class="api-feature-sig">execute: SIMPLE_SQL_EAGER_RESULT</div>
                        <div class="api-feature-desc">Execute the query and return results with loaded relationships.</div>
                    </div>
                </div>
            </div>

            <h2>SIMPLE_SQL_EAGER_RESULT</h2>
            <p>Container for eager-loaded results. Provides access to main rows and their related data.</p>
            <p><a class="eis-link" href="eiffel:?class=SIMPLE_SQL_EAGER_RESULT">View Source</a></p>

            <div class="api-class">
                <div class="api-class-header">
                    <h2>Access</h2>
                </div>
                <div class="api-class-body">
                    <div class="api-feature">
                        <div class="api-feature-sig">main_rows: SIMPLE_SQL_RESULT</div>
                        <div class="api-feature-desc">The main table query results.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">related (a_relation: READABLE_STRING_8): HASH_TABLE [ARRAYED_LIST [SIMPLE_SQL_ROW], INTEGER_64]</div>
                        <div class="api-feature-desc">Get all loaded related data for a relation, keyed by main row ID.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">related_for (a_relation: READABLE_STRING_8; a_id: INTEGER_64): ARRAYED_LIST [SIMPLE_SQL_ROW]</div>
                        <div class="api-feature-desc">Get related rows for a specific main row ID.</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">first_related_for (a_relation: READABLE_STRING_8; a_id: INTEGER_64): detachable SIMPLE_SQL_ROW</div>
                        <div class="api-feature-desc">Get first related row (for 1:1 or N:1 relationships).</div>
                    </div>
                    <div class="api-feature">
                        <div class="api-feature-sig">related_count (a_relation: READABLE_STRING_8; a_id: INTEGER_64): INTEGER</div>
                        <div class="api-feature-desc">Count of related rows for a main row.</div>
                    </div>
                </div>
            </div>

            <h2>Examples</h2>

            <h3>Direct Foreign Key (Documents → Folders)</h3>
            <pre><code class="eiffel"><span class="keyword">local</span>
    result: <span class="class-name">SIMPLE_SQL_EAGER_RESULT</span>
    doc_id: <span class="class-name">INTEGER_64</span>
<span class="keyword">do</span>
    <span class="comment">-- Load documents with their folders (2 queries total)</span>
    result := db.eager_loader
        .from_table (<span class="string">"documents"</span>)
        .include (<span class="string">"folder"</span>, <span class="string">"folders"</span>, <span class="string">"folder_id"</span>, <span class="string">"id"</span>)
        .execute

    <span class="comment">-- Access the data</span>
    <span class="keyword">across</span> result.main_rows <span class="keyword">as</span> doc <span class="keyword">loop</span>
        doc_id := doc.integer_64_value (<span class="string">"id"</span>)
        print (<span class="string">"Document: "</span> + doc.string_value (<span class="string">"name"</span>))

        <span class="keyword">if</span> <span class="keyword">attached</span> result.first_related_for (<span class="string">"folder"</span>, doc_id) <span class="keyword">as</span> folder <span class="keyword">then</span>
            print (<span class="string">" in folder: "</span> + folder.string_value (<span class="string">"name"</span>))
        <span class="keyword">end</span>
        print (<span class="string">"%N"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>

            <h3>Many-to-Many (Documents → Tags)</h3>
            <pre><code class="eiffel"><span class="keyword">local</span>
    result: <span class="class-name">SIMPLE_SQL_EAGER_RESULT</span>
    doc_id: <span class="class-name">INTEGER_64</span>
<span class="keyword">do</span>
    <span class="comment">-- Load documents with tags through document_tags join table</span>
    result := db.eager_loader
        .from_table (<span class="string">"documents"</span>)
        .include_many_to_many (<span class="string">"tags"</span>, <span class="string">"tags"</span>, <span class="string">"document_tags"</span>, <span class="string">"document_id"</span>, <span class="string">"tag_id"</span>)
        .where (<span class="string">"documents.deleted_at IS NULL"</span>)
        .execute

    <span class="keyword">across</span> result.main_rows <span class="keyword">as</span> doc <span class="keyword">loop</span>
        doc_id := doc.integer_64_value (<span class="string">"id"</span>)
        print (<span class="string">"Document: "</span> + doc.string_value (<span class="string">"name"</span>) + <span class="string">" ["</span>)

        <span class="keyword">across</span> result.related_for (<span class="string">"tags"</span>, doc_id) <span class="keyword">as</span> tag <span class="keyword">loop</span>
            print (tag.string_value (<span class="string">"name"</span>) + <span class="string">" "</span>)
        <span class="keyword">end</span>
        print (<span class="string">"]%N"</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span></code></pre>

            <h3>Multiple Relationships</h3>
            <pre><code class="eiffel">result := db.eager_loader
    .from_table (<span class="string">"documents"</span>)
    .columns (<span class="string">"id, name, folder_id, created_by"</span>)
    .include (<span class="string">"folder"</span>, <span class="string">"folders"</span>, <span class="string">"folder_id"</span>, <span class="string">"id"</span>)
    .include (<span class="string">"author"</span>, <span class="string">"users"</span>, <span class="string">"created_by"</span>, <span class="string">"id"</span>)
    .include_many_to_many (<span class="string">"tags"</span>, <span class="string">"tags"</span>, <span class="string">"document_tags"</span>, <span class="string">"document_id"</span>, <span class="string">"tag_id"</span>)
    .order_by (<span class="string">"created_at DESC"</span>)
    .limit (50)
    .execute

<span class="comment">-- 4 queries total: documents, folders, users, tags (via join table)</span></code></pre>

            <div class="callout success">
                <div class="callout-title">Performance Impact</div>
                <p>Query count: <strong>1 + N relationships</strong> (not 1 + N rows).
                Loading 1000 documents with 3 relationships = 4 queries, not 3001.</p>
            </div>

            <h3>Without Eager Loading (N+1 Problem)</h3>
            <pre><code class="eiffel"><span class="comment">-- BAD: N+1 queries</span>
<span class="keyword">across</span> db.select_from (<span class="string">"documents"</span>).execute <span class="keyword">as</span> doc <span class="keyword">loop</span>
    <span class="comment">-- This executes a query for EACH document!</span>
    folder := db.select_from (<span class="string">"folders"</span>)
        .where (<span class="string">"id = ?"</span>, doc.integer_value (<span class="string">"folder_id"</span>))
        .execute.first
<span class="keyword">end</span></code></pre>

            <h3>With Eager Loading (Efficient)</h3>
            <pre><code class="eiffel"><span class="comment">-- GOOD: 2 queries total</span>
result := db.eager_loader
    .from_table (<span class="string">"documents"</span>)
    .include (<span class="string">"folder"</span>, <span class="string">"folders"</span>, <span class="string">"folder_id"</span>, <span class="string">"id"</span>)
    .execute

<span class="keyword">across</span> result.main_rows <span class="keyword">as</span> doc <span class="keyword">loop</span>
    folder := result.first_related_for (<span class="string">"folder"</span>, doc.integer_64_value (<span class="string">"id"</span>))
<span class="keyword">end</span></code></pre>

            <div class="doc-footer">
                <p><a href="query-monitor.html">← Query Monitor</a> | <a href="paginator.html">Paginator →</a></p>
                <p>See also: <a href="../tutorials/eager-loading.html">Eager Loading Tutorial</a></p>
            </div>
        </main>
    </div>
</body>
</html>
